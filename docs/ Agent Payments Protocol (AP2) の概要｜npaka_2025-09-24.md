# Agent Payments Protocol (AP2) の概要｜npaka

以下は参考ページをもとに整理した、Agent Payments Protocol（AP2）の要点です。概要、詳細（設計・構成要素・ワークフロー・セキュリティ・運用上の考慮点）、具体例（ユースケースとサンプルメッセージ）に分けてまとめます。

---

## 概要
- AP2（Agent Payments Protocol）は、Google が主要な決済／テクノロジー企業と共同で策定した「エージェント主導の支払い」を安全かつ追跡可能に行うためのオープンプロトコル（データ仕様）です。  
- 目的は、複数プラットフォーム（エージェント提供者、商店、決済代行、銀行、会計/CRM 等）にまたがる取引に対して「誰がいつ・どのようにユーザーの許可を与えたか」の証明と責任の所在を明確化すること。既存の決済インフラ（カードネットワーク等）を置き換えるものではなく、上位レイヤーで相互運用性と信頼チェーンを提供します。  
- AP2 は Agent-to-Agent（A2A）プロトコル上に重ねて動作する設計で、モデルプロバイダやエージェント市場（Agent Marketplace）との連携を想定しています。発表時点で多くの企業（約60社規模）が関与・支持しているオープン標準です。

---

## 詳細

### 1) 主要な役割（ステークホルダー）
- ユーザー（エンドカスタマー）  
- エージェント（ユーザー代理で動作するAI/ソフトウェア）  
- 商店／マーチャント（商品・サービス提供者）  
- 支払処理事業者（PSP）、決済ネットワーク、銀行・カード発行者  
- モデルプロバイダ／エージェントプラットフォーム（エージェント実行環境・マーケットプレイス）  
- 会計／CRM システム（レコード保持と後処理）  
- オーディット／監査ログ保存先

### 2) 基本目標・提供する機能
- ユーザー承認の証明（proof of authorization）と非否認性（non-repudiation）  
- プラットフォーム横断の相互運用（どのエコシステムでも同じ「承認情報」を理解できる）  
- 誰が・何を承認したか（スコープ、限度、条件）の明確化（例：金額上限、カテゴリ制限、定期購入のみ許可など）  
- 監査可能なトラストチェーン（署名付きメッセージ、タイムスタンプ、返却レシート等）  
- 既存の決済レール（カード、ACH、ウォレット等）との連携（AP2 が清算を行うわけではない）

### 3) 技術的要素（高レベル）
- メッセージ仕様（支払要求・承認・レシート・ステータス通知等のフォーマット）  
- デジタル署名と証明（エージェント／プラットフォーム／ユーザーの署名、検証可能な証跡）  
- 「デリゲーション」や「スコープ」：エージェントに与えられた権限（期間、金額上限、カテゴリ等）を明示するトークン／証明書  
- レシート／領収の標準フォーマット（決済処理後の検証用）  
- A2A 等の既存エージェントプロトコルとの連携（AP2 は上位のデータプロトコル）

### 4) 支払いワークフロー（典型的な流れ）
1. ユーザーがエージェントに「〜を注文して」「再注文を任せる」など権限を付与（事前にデリゲーション設定）  
2. エージェントが支払いを行う必要が生じた際、AP2 準拠の「支払要求（payment_intent）」を生成。ここに金額・通貨・マーチャント情報・ユーザーのデリゲーション証明（署名付き）などを含める  
3. 商店または PSP がその要求を受け、AP2 メッセージに含まれる署名・証明を検証して承認可否を判断  
4. 決済処理は従来の決済手段（カード決済、口座振替、ウォレット）で実行。AP2 はそれを呼び出すための認可情報と監査証跡を提供  
5. 決済完了後、商店／PSP が署名付きのレシート（settlement receipt）を発行し、エージェント／プラットフォーム／ユーザーへ返送。ログは監査用に保存される

### 5) セキュリティとプライバシー
- 署名付きメッセージによる改竄防止・非否認性  
- 最小権限の原則（スコープ・金額上限・有効期限）でリスク軽減  
- プライバシー保護：必要最小限の取引メタデータのみ共有する設計が推奨（決済処理自体は既存のレールで暗号化）  
- 監査ログ・証跡の長期保管（法規制・コンプライアンス対応）  
- 不正検知と異常時の停止・取り消し（リスク管理ポリシーが必要）

### 6) 責任・争議解決（設計上の留意点）
- AP2 は「誰が最終的に責任を負うか」を技術的に示せるようにするが、法的責任分配は契約・規制による。各参加事業者は役割に基づく責任分担ルール（例：エージェント提供者の保証、マーチャントの確認義務、PSP の不正検知義務）を定める必要がある。  
- 争議発生時は、AP2 のログ・署名情報が証拠として利用される。

### 7) AP2 の位置づけと現状
- AP2 はオープンプロトコル（仕様）であり、決済ネットワークそのものではない。  
- Google が発表し、多数の企業が賛同している。Agent Marketplace やモデル提供者が対応を進めることで実用化が期待される。  
- 実運用には PSP・商店・銀行・プラットフォーム側の実装・協調が必要で、段階的な導入・パイロットが現実的。

---

## 具体例

### ユースケース例
1. 定期購入の自動更新
   - ユーザーが「月額サブスクの更新を任せる（上限 $30）」とエージェントに権限を付与。AP2 のスコープは「サブスク更新」「上限 $30」「期限 1年」。サブスクの請求日にエージェントが AP2 の支払要求を出し、PSP が検証して決済。完了レシートを発行。

2. 食料品の再注文
   - 冷蔵庫の在庫情報を参照するエージェントが不足を検知し、事前に与えた条件（合計 $100 まで、ブランド制限あり）に基づいて購入。購入時にAP2メッセージで許可証を添付して実行。

3. 旅行手配（部分的代理）
   - ユーザーが旅行の予算や旅行条件を事前に設定。フライトの最適なオプションが見つかるとエージェントが即時購入。高額な取引の場合は追加確認フロー（都度ユーザー承認）を設けることも可能。

### サンプル（概念）メッセージ（JSONライク）
- 支払要求（payment_intent）の例（簡略）
  {
    "type": "payment_intent",
    "id": "pi_12345",
    "amount": 49.99,
    "currency": "USD",
    "merchant_id": "merchant_abc",
    "merchant_reference": "order_987",
    "agent_id": "agent_xyz",
    "user_delegation": {
      "delegation_id": "del_0001",
      "scope": ["purchase:groceries"],
      "max_amount": 100,
      "expires_at": "2026-09-20T00:00:00Z",
      "signed_by_user": "<ユーザー署名データ>"
    },
    "agent_signature": "<エージェント署名データ>",
    "timestamp": "2026-09-01T12:34:56Z"
  }

- レシート（settlement_receipt）の例
  {
    "type": "settlement_receipt",
    "payment_intent_id": "pi_12345",
    "status": "settled",
    "settlement_id": "settle_555",
    "processor_reference": "psp_tx_999",
    "amount": 49.99,
    "currency": "USD",
    "merchant_signature": "<商店署名>",
    "timestamp": "2026-09-01T12:35:40Z"
  }

（注意：上記は概念例で、実際のAP2 仕様の形式は仕様書に従います）

---

## 導入時の実務的なポイントと注意点
- 必須の実装要素：署名検証、デリゲーション管理、監査ログ、エラー/争議フロー、決済レールとのブリッジ  
- 規制対応：KYC/AML、支払い認可法規、消費者保護に関する地域規制への配慮が必要  
- リスク管理：エージェントの誤動作や悪用リスクに対する監視・レート制限・上限設定の設計  
- UX設計：エンドユーザーがどのレベルでどのように権限を与えるか（明示的承認、事前設定、都度確認）を分かりやすく提示すること  
- 運用協定：商店、PSP、プラットフォーム間で責任分担・エラー対応・返金処理ルールを締結しておく

---

## まとめ（要点）
- AP2 は「エージェントによる支払いを安全かつ追跡可能に行うためのオープンなデータプロトコル」で、既存決済インフラを置き換えるものではなく、承認証跡と相互運用を提供する上位レイヤー。  
- 署名・デリゲーション・標準化されたメッセージにより、誰が何を許可したかを明確化し、責任の所在や監査可能性を高める。  
- 実用化にはプラットフォーム、PSP、マーチャント、銀行など数多くのプレイヤーの実装と協調が必要で、段階的導入・パイロットが現実的。  

必要であれば、AP2 仕様書の主要なメッセージ一覧（payment_intent、authorization、settlement_receipt 等）や、導入チェックリスト（実装項目別）を作成します。どの情報がさらに必要か教えてください。