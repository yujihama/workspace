以下は「Stripeの請求書（Invoice）を n8n で取得する方法」について、概要・詳細・具体例を分かりやすく整理したものです。n8n標準ノードでできることと、標準ノードで対応していない操作を補うための HTTP リクエスト手順も含めています。

概要
- 目的：Stripe の Invoice（請求書）オブジェクトや請求書 PDF／明細を n8n ワークフロー内で取得・利用する方法。
- 主な手法：
  1. n8n の Stripe ノード（Resource = Invoice）を使う（Get / Get All など）。
  2. Stripe が公開する REST API を n8n の HTTP Request ノードで直接叩く（Invoice の PDF や一部 API はこちらが必要）。
  3. Stripe の Webhook をトリガーにしてリアルタイム取得・処理する（invoice.created / invoice.finalized / invoice.payment_succeeded 等）。
- 実用例：請求書発行の通知、PDF を Google Drive に保存、未入金の請求書一覧取得、顧客ごとの請求書ダウンロードなど。

詳細
1) 事前準備（API キー・n8n の認証設定）
- Stripe ダッシュボードで Secret API Key（テスト用なら sk_test_...）を取得する。
- n8n の Stripe ノードにこのキーを登録（n8n の Credential 作成）。テスト／本番を間違えないように注意。
- Webhook を使う場合は Stripe 側でエンドポイントを登録、署名シークレットがあれば n8n で検証する設定を行う。

2) n8n の Stripe ノードでの取得（標準的な方法）
- Node 設定例：
  - Resource: Invoice
  - Operation: Get（単一取得）、Get All（一覧取得）
  - Invoice ID: 取得したい invoice の id（ex: inv_1Hxxxx）
  - Get All の場合は limit / filters（customer など）を指定可能（ノードのバージョンによりフィールド名は若干異なる場合あり）。
- 出力される主なフィールド（代表例）：
  - id, amount_due, currency, status, customer, hosted_invoice_url, invoice_pdf, lines（請求明細配列）
- 注意点：
  - ノードのバージョンによってはすべての API 機能をカバーしていない（例：PDF ダウンロード機能や lines の細かい取得などは HTTP リクエストが必要な場合がある）。

3) HTTP Request ノードを使う（ノードで対応していない機能の取得方法）
- 利点：Stripe の任意のエンドポイントを使える（例：/v1/invoices/{id}/pdf、/v1/invoices/upcoming、/v1/invoices/{id}/lines の細かいページネーション等）。
- 認証：
  - Authorization ヘッダに Bearer Token をセット： Authorization: Bearer sk_test_xxx
  - n8n の HTTP Request ノードで「Header Auth」またはヘッダ直接指定。
- PDF を取得してバイナリで保存する場合（HTTP Node 設定例）：
  - Method: GET
  - URL: https://api.stripe.com/v1/invoices/{INVOICE_ID}/pdf
  - Headers: Authorization: Bearer sk_test_xxx
  - Response Format: File / Return Binary Data（n8n の「Binary」出力を使って Google Drive 等へ保存）
- その他の API 例：
  - 一覧取得: GET https://api.stripe.com/v1/invoices?customer=cus_123&limit=100
  - upcoming invoice: GET https://api.stripe.com/v1/invoices/upcoming?customer=cus_123

4) Webhook を使った推奨フロー（リアルタイム処理）
- Stripe 側で invoice.created / invoice.finalized / invoice.payment_succeeded などを webhook 送信するよう設定。
- n8n Webhook ノードを受け取り、イベント内の invoice id は通常 payload.data.object.id に入るので、以降の Stripe ノードや HTTP Request で詳細を取得する。
- 例：Webhook -> Stripe Node (Get Invoice using {{$json["data"]["object"]["id"]}}) -> Google Sheets や Slack などへ通知／保存。

5) 請求書作成系の注意点（n8n で「請求書を作る」場合）
- Stripe Invoicing の典型的な流れ：InvoiceItem（明細）を作成 -> Invoice 作成 -> finalizeInvoice（確定） -> sendInvoice（送付）
- n8n の Stripe ノードが「Invoice 作成」や「Finalize」など完全対応していないことがある。対応していない操作は HTTP Request で以下を呼ぶ：
  - Create invoice item: POST /v1/invoiceitems
  - Create invoice: POST /v1/invoices
  - Finalize: POST /v1/invoices/{invoice}/finalize
  - Send invoice: POST /v1/invoices/{invoice}/send

6) ページネーションとレート制限
- Stripe の一覧 API はページネーション（starting_after / ending_before / limit）を使う。大量データ取得時はループして全件取得する実装が必要。
- Stripe のレート制限に留意（エラー時はリトライや間引き処理を実装）。

具体例（n8n ワークフローの具体的構成例と設定例）
例 A：Webhook で請求書作成をトリガーして請求書の詳細を取得、PDF を Google Drive に保存
1. Stripe（Stripe側）→Webhook設定で n8n の Webhook エンドポイント（/webhook1）を登録。イベント：invoice.finalized（確定済みの請求書）。
2. n8n の Webhook ノード（HTTP POST を受け取る）。
3. Function（または Set）ノードで invoice id を抽出： {{$json["data"]["object"]["id"]}}（例: inv_1Hxxxx）
4. HTTP Request ノード（PDF 取得）設定：
   - Method: GET
   - URL: https://api.stripe.com/v1/invoices/{{$json["data"]["object"]["id"]}}/pdf
   - Authentication: Header → Authorization: Bearer sk_test_xxx（または HTTP ヘッダに手動設定）
   - Response Format: File / Return Binary Data
5. Google Drive ノード（Upload）にバイナリデータを渡して保存（ファイル名例: {{$json["data"]["object"]["number"]}}.pdf）。
6. Slack / Gmail ノードで保存完了通知や送付。

例 B：定期的に未入金（open/unpaid）の請求書一覧を取得して CSV を作る
1. Cron ノード（毎日）
2. Stripe ノード（Resource: Invoice / Operation: Get All）
   - Filters: status=open または status=unpaid（ノードがフィルタ対応していない場合、HTTP Request で GET /v1/invoices?status=open）
   - Limit: 100（必要に応じてページネーション）
3. For Each（または SplitInBatches）で各 invoice を処理し、必要項目（id, amount_due, due_date, customer, hosted_invoice_url）を抽出。
4. CSV/Google Sheets ノードにアップロード・保存。
5. Slack に警告（30 日以上の延滞などの条件で通知）。

例 C：顧客作成直後に請求書を作って送る（API を使うパターン）
1. Stripe Node で Customer 作成（あるいは既存顧客 ID を利用）。
2. HTTP Request で /v1/invoiceitems を POST（amount, currency, customer, description）で明細作成。
3. HTTP Request で /v1/invoices を POST（customer=cus_xxx） -> レスポンスで invoice id を取得。
4. HTTP Request で POST /v1/invoices/{invoice_id}/finalize で確定。
5. 必要なら POST /v1/invoices/{invoice_id}/send（または hosted_invoice_url を使って顧客に共有）。

n8n の表現（Expression）例
- Webhook の payload から invoice id を取得： {{$json["data"]["object"]["id"]}}
- customer id を参照： {{$json["data"]["object"]["customer"]}}

運用上のポイント・Tips
- テストモードとライブモードのキーを使い分ける（n8n 内の Credential にわかりやすい名前をつける）。
- Webhook の署名検証（Stripe の署名シークレット）を使うとセキュリティ向上（n8n での検証処理を挟む）。
- Invoice の PDF はノードから直接取得できないことがあるため、HTTP Request + Binary 出力の使い方を覚えておくと便利。
- 大量データを扱う場合はページネーション、再試行、レート制限（429）のハンドリングを実装する。
- n8n の Stripe ノードは機能が追加され続けているため、最新版ノードのドキュメント／コミュニティを定期的に確認する。

参考になるチェックリスト（実装前に確認）
- Stripe の Secret Key を用意したか（テスト/本番）。
- 取得したいデータ（invoice 詳細 / lines / PDF / upcoming）のエンドポイントが n8n の Stripe ノードで対応しているか確認 → 非対応なら HTTP Request を使う。
- Webhook を使う場合は署名の検証手順を決めたか。
- 大量取得時のページネーション設計はどうするか（limit, starting_after）。
- 保存先（Google Drive / S3 / DB）の binary ハンドリングを確認したか。

最後に
- よく使う用途（一覧取得・PDF保存・Webhook連携）は上記でカバーできます。n8n の Stripe ノードで足りない機能は HTTP Request ノードで補うのが一般的なパターンです。
- 必要であれば、あなたの目的（例：Webhook で受け取った invoice PDF を自動保存、あるいは定期的に未払い請求書をSlack通知）を教えてください。具体的な n8n ノード設定やサンプルワークフロー（ノード順、Expression の具体値、HTTP Request の詳細ヘッダなど）をステップごとに作成します。